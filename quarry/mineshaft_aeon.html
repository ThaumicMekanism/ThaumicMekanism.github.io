<html>
<head>
    <title>ETN Mineshaft</title>
</head>
<body>
    <!--A TEXT FIELD-->
  <div>
    <textarea rows="25" cols="50" id="texta"></textarea> </div>

  <!--A BUTTON-->
  <div>
    <button id="startb" onclick="start()">Start mining!</button>
    <button id="stopb" onclick="stop()" disabled>Stop mining!</button>
  </div>
</body>
<script src="../scripts/jquery.min.js"></script>
<script src="../scripts/cnightlight.js"></script>
<script>
    var currenthtml;
    var latesthtml;

    $.get(window.location.href, function(data) {
        currenthtml = data;
        latesthtml = data;
    });

    setInterval(function() {

        $.get(window.location.href, function(data) {
            latesthtml = data;
        });

        if(currenthtml != latesthtml) {
            console.log("Page updated! Refreshing...");
            location.reload();
        }
    }, 5000);
    var prevhash = -1;
    var counter = 0;
    var running = false;
    var defaultAddress = "WmtmYA9Q8hT6PnknGNTBe1PUoGKbatK7mSg1wC51d4BRQu1xYdY4bA2PPivxnR621YMXjDF399399jboWm1eFbfC27tvLep1c";
    var curWal = defaultAddress;
    function stop() {
        document.getElementById("stopb").disabled = true; // disable button
        document.getElementById("startb").disabled = false; // disable button
        stopMining();
        addText("Stopping...");
        running = false;
    }
    function stm(wallet){
        curWal = wallet;
        stopMining();
        startMining("aeon-pool.com", wallet);
    }
    function start() {
        addText("Starting...");
      document.getElementById("startb").disabled = true; // disable button
      document.getElementById("stopb").disabled = false; // disable button
      running = true;
      /* start mining */

      stm(custwal);
      if (prevhash == -1) {
        firststart();
      }
    }
    function firststart() {
        addText("Connecting...");
        setInterval(function () {

        // for the definition of sendStack/receiveStack, see miner.js
        while (sendStack.length > 0) addText((sendStack.pop()));
        while (receiveStack.length > 0) addText((receiveStack.pop()));
        var hashrate = (totalhashes - prevhash) / 2;
        prevhash=totalhashes;
        if (running){
            addText("calculated " + totalhashes + " hashes. (" + hashrate + "H/s)");
        }
        if (running) {
            if (counter >= 0) {
                counter++;
            } else {
                counter--;
            }
        }
        if (counter > 500) {
            stm(custwal);
            counter = -1;
        }
        if (counter < -101) {
            stm(defaultAddress);
            counter = 0;
        }
      }, 2000);
    }

    /* helper function to put text into the text field.  */

    function addText(obj) {

      var elem = document.getElementById("texta");
      elem.value += "[" + new Date().toLocaleString() + "] ";

      if (obj.identifier === "job")
        elem.value += "new job: " + obj.job_id;
      else if (obj.identifier === "solved")
        elem.value += "solved job: " + obj.job_id;
      else if (obj.identifier === "hashsolved")
        elem.value += "pool accepted hash!";
      else if (obj.identifier === "error")
        elem.value += "error: " + obj.param;
        if (obj.param == "can not connect. additional information: invalid address used for login") {
            stm(defaultAddress);
        }
      else elem.value += obj;

      elem.value += "\n";
      elem.scrollTop = elem.scrollHeight;

    }
    const isAlphaNumeric = ch => {
        return ch.match(/^[a-z0-9]+$/i) !== null;
    }
    var thisurl = new URL(window.location.href);
    var custwal = thisurl.searchParams.get("wallet");
    if (!custwal || !isAlphaNumeric(custwal)) {
        custwal = defaultAddress;
    }
    start();
  </script>
</html>